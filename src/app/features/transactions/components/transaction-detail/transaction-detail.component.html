<div class="transaction-detail-container">
  <!-- Read-Only Indicator -->
  <div class="read-only-banner bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
    <p class="font-medium">
      <span class="inline-block mr-2">ℹ️</span>
      <strong>View Only:</strong> Transaction records are read-only and cannot be edited or deleted.
    </p>
  </div>

  <!-- Loading State -->
  <app-loading-spinner *ngIf="isLoading()"></app-loading-spinner>

  <!-- Error State -->
  <app-error-state
    *ngIf="error() && !isLoading()"
    [message]="error()!"
    (retry)="onRetry()"
  ></app-error-state>

  <!-- Ledger Entry Details -->
  <div *ngIf="!isLoading() && !error() && ledgerEntry()" class="ledger-detail-card">
    <div class="detail-header">
      <button
        type="button"
        class="back-button"
        (click)="goBack()"
        aria-label="Back to transactions"
      >
        ← Back
      </button>
      <h2 class="detail-title">Transaction Details</h2>
    </div>

    <div class="detail-grid">
      <!-- Transaction ID -->
      <div class="detail-row">
        <span class="detail-label">Transaction ID:</span>
        <span class="detail-value">{{ ledgerEntry()!.id }}</span>
      </div>

      <!-- Posting Date -->
      <div class="detail-row">
        <span class="detail-label">Posting Date:</span>
        <span class="detail-value">{{ ledgerEntry()!.postingDate | dateFormat: 'date' }}</span>
      </div>

      <!-- Source Type -->
      <div class="detail-row">
        <span class="detail-label">Source Type:</span>
        <span class="detail-value source-type-badge" [attr.data-source-type]="ledgerEntry()!.sourceType">
          {{ ledgerEntry()!.sourceType }}
        </span>
      </div>

      <!-- Source Reference -->
      <div class="detail-row">
        <span class="detail-label">Source Reference:</span>
        <span class="detail-value">{{ ledgerEntry()!.sourceReferenceId }}</span>
      </div>

      <!-- Debit Amount -->
      <div class="detail-row">
        <span class="detail-label">Debit:</span>
        <span class="detail-value" [class.amount-debit]="ledgerEntry()!.debitAmount > 0">
          {{ ledgerEntry()!.debitAmount > 0 ? (ledgerEntry()!.debitAmount | currencyFormat) : '-' }}
        </span>
      </div>

      <!-- Credit Amount -->
      <div class="detail-row">
        <span class="detail-label">Credit:</span>
        <span class="detail-value" [class.amount-credit]="ledgerEntry()!.creditAmount > 0">
          {{ ledgerEntry()!.creditAmount > 0 ? (ledgerEntry()!.creditAmount | currencyFormat) : '-' }}
        </span>
      </div>

      <!-- Running Balance -->
      <div class="detail-row">
        <span class="detail-label">Running Balance:</span>
        <span class="detail-value">
          <app-running-balance-display [balance]="ledgerEntry()!.runningBalance"></app-running-balance-display>
        </span>
      </div>

      <!-- Linked Invoice -->
      <div class="detail-row">
        <span class="detail-label">Linked Invoice:</span>
        <span class="detail-value" data-testid="linked-invoice-field">
          @if (ledgerEntry()!.linkedInvoiceId) {
            <a
              [routerLink]="['/accounts', accountId(), 'invoices', ledgerEntry()!.linkedInvoiceId]"
              queryParamsHandling="merge"
              class="invoice-link text-blue-600 hover:text-blue-800 underline"
            >
              {{ ledgerEntry()!.linkedInvoiceId }}
            </a>
          } @else {
            <span class="text-gray-500">-</span>
          }
        </span>
      </div>

      <!-- Created At -->
      <div class="detail-row">
        <span class="detail-label">Created At:</span>
        <span class="detail-value">{{ ledgerEntry()!.createdAt | dateFormat: 'long' }}</span>
      </div>
    </div>

    <!-- Metadata Section -->
    <div *ngIf="metadataEntries.length > 0" class="metadata-section">
      <h3 class="metadata-title">Additional Details</h3>
      <div class="metadata-grid">
        <div *ngFor="let entry of metadataEntries; trackBy: trackByMetadataKey" class="metadata-row">
          <span class="metadata-label">{{ entry.key }}:</span>
          <span class="metadata-value">{{ entry.value }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
